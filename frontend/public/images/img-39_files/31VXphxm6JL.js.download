(function(k){var g=window.AmazonUIPageJS||window.P,m=g._namespace||g.attributeErrors,d=m?m("EbooksBottomSheetAssets",""):g;d.guardFatal?d.guardFatal(k)(d,window):d.execute(function(){k(d,window)})})(function(k,g,m){k.when("jQuery","A").register("BottomSheet-Surface-Helper",function(d,g){return{createDeclarativeHandlers:function(b){b&&"function"===typeof b&&(g.declarative("carousel_item_clicked","click",b),g.declarative("carousel_item_clicked","keypress",function(d){var f=d.$event;!f||32!==f.which&&
13!==f.which||b(d)}))},setSurfaceCarouselSettings:function(){},getTitleTargetFromDeclarative:function(b){if(b&&b.$event&&"function"===typeof b.$event.preventDefault)return b.$event.preventDefault(),b.$currentTarget},orientationChange:function(){},getDeliverToDevice:function(b,l){b=d("form#"+(b?b:"buyOneClick")+" select#"+(l?l:"deliverTo"));return b.length?b.val():""},getTYPParamsFromRequests:function(b){return"transfer-via-computer"===b?"action\x3dtransfer-via-computer\x26a\x3dtransfer-via-computer":
b?"a\x3d"+b:""},addDeviceAccountIdToRequests:function(b,d){b.forEach(function(b){b.asin&&d&&(b.deviceAccountId=d)})}}});k.register("KU-ReturnAndBorrowSheet-CSM",function(){function d(b,d){g.ues&&"function"===typeof ues&&ues("id",d,b)}function k(b,d){g.uet&&"function"===typeof uet&&uet("bb",b,{wb:1},d)}function b(b){g.uex&&"function"===typeof uex&&uex("ld",b,{wb:1})}return{bindRequest:d,widgetBegin:k,widgetEnd:b,ManualTimeCSM:function(g){var f,n,a;this.manualWidgetBegin=function(){n=new Date};this.setWidgetSuffix=
function(b){a=b};this.addRequestId=function(a){f=a};this.manualWidgetEnd=function(){var p=a?g+a:g;k(p,n);d(f,p);b(p)}}}});k.when("jQuery","A","a-modal","KU-ReturnAndBorrowSheet-CSM","BottomSheet-Surface-Helper").register("KU-ReturnAndBorrowSheet-Helper",function(d,k,b,l,f){function n(a,b,d){g.ueLogError&&"function"===g.ueLogError&&g.ueLogError(b,{logLevel:a,attribution:"ku_dpx_return_and_borrow",message:"[KU-DPX] "+d})}return{Helper:function(){function a(e){function a(c,e){e=e||2;return(Array(e).join("0")+
c).slice(-e)}0===e.indexOf("#")&&(e=e.slice(1));3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);if(6!==e.length)throw Error("Invalid HEX color - "+e);var c=(255-parseInt(e.slice(0,2),16)).toString(16),b=(255-parseInt(e.slice(2,4),16)).toString(16);e=(255-parseInt(e.slice(4,6),16)).toString(16);return"#"+a(c)+a(b)+a(e)}function p(e){e={name:e,hideHeader:!0};b.create(d("#"+e.name+"Trigger"),e).show()}function u(e){e.headers=e.headers?e.headers:{};var a=h.CSRF_TOKEN;a&&""!==a||(a=k.state("csrfData")||
{},a=a.csrfToken!==m?a.csrfToken:"");""===a?(n("FATAL",null,"NO CSRF token found"),v.showReturnAndBorrowErrorDialog()):(e.headers["X-CSRFToken"]=a,d.ajax(e))}if(1>arguments.length)return n("FATAL",null,"ReturnAndBorrowSheetHelper init: widgetContext missing"),!1;var h=arguments[0],v=this;this.returnAndBorrow=function(a,b,c,d,k,q){if(!h)return n("FATAL",null,"Calling returnAndBorrow without initializing"),!1;b=v.cloneObject(b);var w=v.getDeliverToDevice();f&&"function"===typeof f.addDeviceAccountIdToRequests&&
f.addDeviceAccountIdToRequests(b,w);b={type:"POST",url:h.RETURN_AND_BORROW_ENDPOINT+k,headers:{isFromDP:!0},contentType:"application/json",data:JSON.stringify(b),dataType:"json",timeout:5E3,error:function(a){d(a)},success:function(b,d,v){d=v&&v.getResponseHeader?v.getResponseHeader("x-amz-rid"):"";l.bindRequest(d,h.WIDGET_NAME_BOTTOM_SHEET);q&&q.addRequestId(d);l.bindRequest(d,a);l.widgetEnd(a);(function(){if(b.allSucceeded)return!0;if(b.succeededResults&&b.succeededResults.length){var a=b.succeededResults.filter(function(a){return a.requestedBorrowAsin===
h.ASIN&&a.workflowResponse&&"KLU_BORROW_SUCCEEDED"===a.workflowResponse.resultCode});return a&&a.length}return!1})()?(d="",f&&"function"===typeof f.getTYPParamsFromRequests&&(d=f.getTYPParamsFromRequests(w)),g.location=h.TYP_BASE_URL+"\x26asin\x3d"+h.ASIN+"\x26subtype\x3d"+h.BORROW_SUB_TYPE+"\x26borrowingProgram\x3d"+h.PROGRAM+"\x26redirectionChecked\x3d1\x26"+d):c(b)}};l.widgetBegin(a);u(b)};this.getLoans=function(a,b){if(!h)return n("FATAL",null,"Calling getLoans without initializing"),!1;var c=
new l.ManualTimeCSM(h.WIDGET_NAME_GET_LOANS),f={type:"POST",url:h.GET_LOANS_ENDPOINT+h.BORROW_BUTTON_REF_TAG,contentType:"application/json",data:JSON.stringify({programName:h.PROGRAM,programChannel:h.CHANNEL?h.CHANNEL:"ALL_YOU_CAN_READ",currentPageKey:h.CURRENT_PAGE_KEY}),dataType:"html",timeout:1E4,success:function(b,f,g){f=g&&g.getResponseHeader?g.getResponseHeader("x-amz-rid"):"";l.bindRequest(f,h.WIDGET_NAME_GET_LOANS);l.bindRequest(f,h.WIDGET_NAME_BOTTOM_SHEET_ELAPSED);l.widgetEnd(h.WIDGET_NAME_GET_LOANS);
g=d(b).find(".carouselItem").length;c.setWidgetSuffix("ActiveLoans"+g);c.addRequestId(f);c.manualWidgetEnd();a(b,g)},error:function(a){b(a)}};l.widgetBegin(h.WIDGET_NAME_GET_LOANS);c.manualWidgetBegin();u(f)};this.cloneObject=function(a){return JSON.parse(JSON.stringify(a))};this.composeAbsoluteURL=function(a){return g.location.href.replace(/(:\/*[^/]*).*$/,"$1")+("/"===a.charAt(0)?"":"/")+a};this.showReturnAndBorrowErrorDialog=function(){p(h.ERROR_MODAL_PRELOAD_NAME)};this.showReturnAndBorrowIOUInfoDialog=
function(){p(h.IOU_MODAL_PRELOAD_NAME)};this.invertColor=function(b){return b.startsWith("rgb")?(b=b.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),"rgb("+(255-b[1])+","+(255-b[2])+","+(255-b[3])+")"):a(b)};this.getDeliverToDevice=function(){return f&&"function"===typeof f.getDeliverToDevice?f.getDeliverToDevice(h.FORM_NAME,h.DELIVER_TO_FIELD):""}},logError:n}});k.when("jQuery","A","a-carousel-framework","a-button","KU-ReturnAndBorrowSheet-Helper","KU-ReturnAndBorrowSheet-CSM","BottomSheet-Surface-Helper").register("KU-ReturnAndBorrowSheet",
function(d,t,b,l,f,n,a){function p(){var a=d("#shelfSpinnerContainer"),b=d("#shelfSpinnerContainer #shelfSpinner"),f=this;this.toggle=function(c){a.toggleClass("shelfSpinnerContainerShow a-spacing-small",c);a.toggleClass("shelfSpinnerContainerHide aok-hidden",!c);b.toggleClass("aok-hidden",!c)};this.show=function(){f.toggle(!0)};this.hide=function(){f.toggle(!1)}}function u(){var a={},b=this;this.get=function(){return Object.keys(a)};this.count=function(){return b.get().length};this.reset=function(){a=
{}};this.update=function(d,c){c?a[d]=!0:delete a[d];return b.count()}}function h(){function g(b){var c;a&&"function"===typeof a.getTitleTargetFromDeclarative&&(c=a.getTitleTargetFromDeclarative(b));b=b.data.loanId;var d=c.siblings(".carouselSelectedMarker"),e=!d.length;e?(c.after('\x3cdiv class\x3d"carouselSelectedMarker carouselItem"\x3e'),d=c.position(),c.siblings(".carouselSelectedMarker").css({top:d.top+"px",left:d.left+"px",height:c.height()+"px",width:c.width()+"px"})):d.remove();0<y.update(b,
e)?q.enable():q.disable()}function e(e,g){B.empty();e?(B.append(e),c(),B.removeClass("aok-hidden"),b.createAll(),b.initializeAll(),e=b.getCarousel(d("#shelfContainer",x)),a&&"function"===typeof a.setSurfaceCarouselSettings&&a.setSurfaceCarouselSettings(e),n.widgetEnd(m),A.setWidgetSuffix("ActiveLoans"+g),A.manualWidgetEnd()):(f.logError("ERROR",null,"Get loans request succeeded, but got empty response."),t());z.hide()}function h(a){f.logError("ERROR",null,"Get loans request failed with error: "+a);
w();z.hide()}function c(){var a=d(D),b=0,c=0;a.load(function(){b++;c=Math.max(c,d(this).outerHeight());b===a.length&&k(c)})}function k(a){d(D).each(function(){var b=a-d(this).outerHeight();d(this).css("margin-top",b+"px")});var b=a+5;d("#shelfContainer",x).find("ol").css("height",b+"px")}if(6>arguments.length)return f.logError("FATAL",null,"Carousel init: not properly constructed ["+arguments.length+"]"),!1;var l=arguments[0],q=arguments[1],w=arguments[2],t=arguments[3],x=arguments[4],m=arguments[5],
A=arguments[6],z=new p,y=new u,B=d(x+" #shelfCarouselContent"),D=x+" .shelfCarouselContainer img";a&&"function"===typeof a.createDeclarativeHandlers&&a.createDeclarativeHandlers(g);this.update=function(){z.show();B.addClass("aok-hidden");q.disable();y.reset();"function"===typeof l&&l(e,h)};this.getSelectedLoanIds=function(){return y.get()}}return{ReturnAndBorrowSheetWidget:function(){function a(b){w.addClass("aok-hidden");u.addClass("aok-hidden");k.when("mash").execute(function(a){"function"===typeof a.dispatchEvent&&
a.dispatchEvent({type:"appOverlays."+("On"===b?"Hide":"Show")})});"On"===b?(m.removeClass("aok-hidden"),q.css("height",d(document).height()),q.removeClass("aok-hidden")):(m.addClass("aok-hidden"),q.addClass("aok-hidden"))}function b(a){var d="",e;if(a.failedResults&&a.failedResults.length){var f=a.failedResults.filter(function(a){return a.requestedBorrowAsin===c.ASIN});f&&f.length&&(e=f[0],d=f[0].workflowResponse.resultCode)}switch(d){case "KLU_ALREADY_BORROWED":case "ALREADY_PURCHASED":y.hide();
r.showReturnAndBorrowIOUInfoDialog();break;case "KLU_CONCURRENT_LIMIT_REACHED":g.location=c.RnB_PAGE_URL+"\x26ASIN\x3d"+c.ASIN+"\x26continueAction\x3d"+c.CONTINUE_ACTION+"\x26program\x3d"+c.PROGRAM+"\x26channel\x3d"+c.CHANNEL+"\x26ref_\x3d"+c.BORROW_BUTTON_REF_TAG+"\x26a\x3d"+r.getDeliverToDevice();break;case "KLU_BOTTOM_SHEET":y.show();break;case "CHOOSE_DEVICE":a=r.composeAbsoluteURL(c.NON_AJAX_RNB_ENDPOINT+"/ref\x3d"+c.RETURN_AND_BORROW_BUTTON_REF_TAG+"?asin\x3d"+c.ASIN+"\x26program\x3d"+c.PROGRAM+
"\x26channel\x3d"+c.CHANNEL+"\x26action\x3dtransfer-via-computer\x26csrfToken\x3d"+encodeURIComponent(c.CSRF_TOKEN));g.location=c.CHOOSE_DEVICE_PAGE_URL+"?asin\x3d"+c.ASIN+"\x26action\x3dtransfer-via-computer\x26buyHandlerCallBackUrl\x3d"+encodeURIComponent(a);break;case "KLU_MFA_FIX_UP":g.location=c.MFA_FIXUP_URL+"?asin\x3d"+c.ASIN+"\x26subtype\x3d"+c.BORROW_SUB_TYPE+"\x26program\x3d"+c.PROGRAM+"\x26channel\x3d"+c.CHANNEL+"\x26action\x3d"+c.CONTINUE_ACTION+"\x26authPageSource\x3dborrowInterrupt";
break;case "KLU_PINCHOT_BORROW_INTERRUPT_ELIGIBLE":g.location=c.PINCHOT_BORROW_INTERRUPT_ELIGIBLE_URL+"?asin\x3d"+c.ASIN+"\x26program\x3d"+c.PROGRAM;break;case "BORROW_DEFERRED":g.location=c.MFA_FIXUP_URL+"?asin\x3d"+c.ASIN+"\x26loanId\x3d"+(e&&e.requestedReturnLoanId?e.requestedReturnLoanId:"")+"\x26subtype\x3d"+c.BORROW_SUB_TYPE+"\x26program\x3d"+c.PROGRAM+"\x26channel\x3d"+c.CHANNEL+"\x26action\x3d"+c.CONTINUE_ACTION+"\x26authPageSource\x3dborrowInterrupt\x26authPageSourceVariant\x3dborrowDeferred";
break;case "KLU_ASIN_INELIGIBLE":g.location=c.INELIGIBLE_ASIN_URL;break;case "KLU_CUSTOMER_NOT_SUBSCRIBED":g.location=c.NOT_SUBSCRIBED_URL+"?passThroughAsin\x3d"+c.ASIN+"\x26ref\x3dku_br_aw_ns";break;case "KLU_CUSTOMER_SUBSCRIBED_WITH_PAYMENT_PROBLEM":g.location=c.getPaymentProblemURL(r,c);break;default:p(a)}}function p(a){a="function"===typeof a.statusCode?a.statusCode():a;f.logError("ERROR",null,"Error occurred while calling returnAndBorrow: "+JSON.stringify(a));y.hide();r.showReturnAndBorrowErrorDialog()}
if(1>arguments.length)return f.logError("FATAL",null,"ReturnAndBorrowSheetWidget init: widgetContext missing"),!1;var c=arguments[0],r=new f.Helper(c),m=d("#"+c.MAIN_CONTAINER_ID),q=d("#"+c.SCRIM_SHEET_ID),w=m.find("#shelfAlertBox"),u=m.find("#shelfNullResponseAlertBox"),x=l("#"+c.MAIN_CONTAINER_ID+" #returnAndContinueButton"),C=new n.ManualTimeCSM(c.WIDGET_NAME_BOTTOM_SHEET);m.css("background-color",c.THEME_COLOR);q.css("background-color",r.invertColor(c.THEME_COLOR));var A=new h(r.getLoans,x,function(){w.removeClass("aok-hidden")},
function(){u.removeClass("aok-hidden")},"#"+c.MAIN_CONTAINER_ID,c.WIDGET_NAME_BOTTOM_SHEET,C),z={asin:c.ASIN,program:c.PROGRAM,channel:c.CHANNEL,loanId:""},y=this;t.declarative("return_and_continue","click",function(){var a=A.getSelectedLoanIds();if(x.isEnabled()&&0<a.length){var d=[],f=0;a.forEach(function(a){var b=r.cloneObject(z);b.loanId=a;0<f++&&(b.asin="");d.push(b)});r.returnAndBorrow(c.WIDGET_NAME_RETURN_AND_BORROW+a.length,d,b,p,c.RETURN_AND_BORROW_BUTTON_REF_TAG)}});this.show=function(){a("On");
n.widgetBegin(c.WIDGET_NAME_BOTTOM_SHEET_ELAPSED);A.update()};this.hide=function(){a("Off");n.widgetEnd(c.WIDGET_NAME_BOTTOM_SHEET_ELAPSED)};this.borrow=function(){n.widgetBegin(c.WIDGET_NAME_BOTTOM_SHEET);C.manualWidgetBegin();r.returnAndBorrow(c.WIDGET_NAME_BORROW,[z],b,p,c.BORROW_BUTTON_REF_TAG,C)}}}});k.when("jQuery").register("KU-ReturnAndBorrowSheet-PaymentProblemURL",function(d){return{getPaymentProblemURL:function(g,b){b.PAYMENT_PROBLEM_URL=b.PAYMENT_PROBLEM_URL?b.PAYMENT_PROBLEM_URL:"/gp/digital/fiona/clarification/prime-borrow-failed";
b.COR=b.COR?b.COR:d("#buyOneClick").attr("cor.0");return b.PAYMENT_PROBLEM_URL+"?ASIN\x3d"+b.ASIN+"\x26cor\x3d"+b.COR+"\x26error\x3dklu_customer_subscribed_with_payment_problem"}}});k.when("jQuery","A").execute("KU-DP-BottomSheet-Bind",function(d,t){function b(a){n=!0;k.now("KU-ReturnAndBorrowSheet").execute("KU-DP-BottomSheet-Bind",function(a){a===m&&(f.hide(),l.removeClass("aok-hidden"),g.ue&&ue.count("ku_bottom_sheet_spinner_displayed",1))})}var l=d("#ku-borrow-button-spinner"),f=d("#borrow-button"),
n=!1;"undefined"===typeof NativeHost&&f.click(b);k.when("KU-DP-BottomSheet-Context","KU-ReturnAndBorrowSheet-PaymentProblemURL","KU-ReturnAndBorrowSheet","BottomSheet-Surface-Helper").register("KU-DP-BottomSheet-Module",function(a,g,k,h){l.hasClass("aok-hidden")||(l.addClass("aok-hidden"),f.show());f.unbind("click",b);a=a.widgetContext;a.CHANNEL=a.CHANNEL?a.CHANNEL:"ALL_YOU_CAN_READ";a.RnB_PAGE_URL=a.RnB_PAGE_URL?a.RnB_PAGE_URL:"/kindle-dbs/hz/return?_encoding\x3dUTF8";a.CONTINUE_ACTION=a.CONTINUE_ACTION?
a.CONTINUE_ACTION:"borrow";a.WIDGET_NAME_BOTTOM_SHEET_ELAPSED=a.WIDGET_NAME_BOTTOM_SHEET_ELAPSED?a.WIDGET_NAME_BOTTOM_SHEET_ELAPSED:"kuDpBottomSheetElapsed";a.MFA_FIXUP_URL=a.MFA_FIXUP_URL?a.MFA_FIXUP_URL:"/kindle-dbs/ku/auth-fixup";a.PINCHOT_BORROW_INTERRUPT_ELIGIBLE_URL=a.PINCHOT_BORROW_INTERRUPT_ELIGIBLE_URL?a.PINCHOT_BORROW_INTERRUPT_ELIGIBLE_URL:"/kindle-dbs/ku/borrow-interrupt";a.INELIGIBLE_ASIN_URL=a.INELIGIBLE_ASIN_URL?a.INELIGIBLE_ASIN_URL:"/dp/"+a.ASIN;a.NOT_SUBSCRIBED_URL=a.NOT_SUBSCRIBED_URL?
a.NOT_SUBSCRIBED_URL:"/kindle-dbs/ku2";a.THEME_COLOR=a.THEME_COLOR?a.THEME_COLOR:d("body").css("background-color");a.NON_AJAX_RNB_ENDPOINT=a.NON_AJAX_RNB_ENDPOINT?a.NON_AJAX_RNB_ENDPOINT:"/kindle-dbs/hz/returnAndBorrow";a.CHOOSE_DEVICE_PAGE_URL=a.CHOOSE_DEVICE_PAGE_URL?a.CHOOSE_DEVICE_PAGE_URL:"/kindle-dbs/clarification/choose-device";a.getPaymentProblemURL=g.getPaymentProblemURL;var m=new k.ReturnAndBorrowSheetWidget(a);"undefined"===typeof NativeHost&&f.click(function(a){a.preventDefault();m.borrow();
return!1});t.declarative&&"function"===typeof t.declarative&&t.declarative("collapseBottomSheet","click",function(){m.hide()});h&&"function"===typeof h.orientationChange&&h.orientationChange(m.hide);n&&m.borrow();return{borrow:m.borrow}})})});